# ==================== ç­–ç•¥æ‰§è¡Œç±» ====================
class VolatilityRSIStrategy:
    def __init__(
        self,
        data_df,
        initial_capital=10000.0,
        params=None
    ):
        """
        :param data_df: å¿…é¡»åŒ…å« timestamp, open, high, low, close åˆ—
        :param initial_capital: åˆå§‹èµ„é‡‘
        :param params: ç­–ç•¥å‚æ•°å­—å…¸ã€‚è‹¥ä¼ å…¥ï¼Œä¼šä¸é»˜è®¤å‚æ•°åˆå¹¶ã€‚æœªæŒ‡å®šçš„å‚æ•°å°†ä¾æ—§ä½¿ç”¨é»˜è®¤å€¼ã€‚
        """
        # é»˜è®¤å‚æ•°
        default_params = {
            "window": 5,              # ä»·æ ¼å˜åŒ–çš„æ»šåŠ¨çª—å£
            "atr_period": 14,         # ATRçš„è®¡ç®—å‘¨æœŸ
            "atr_multiplier": 1.0,    # ATRé˜ˆå€¼å€æ•°
            "take_profit": 2.0,       # æ­¢ç›ˆå€æ•°(åŸºäºATR)
            "stop_loss": 1.5,         # æ­¢æŸå€æ•°(åŸºäºATR)
            "rsi_window": 14,         # RSIçš„è®¡ç®—å‘¨æœŸ
            "rsi_upper": 70,          # RSIä¸Šé˜ˆå€¼
            "rsi_lower": 30,          # RSIä¸‹é˜ˆå€¼
            "max_trades": 10,         # æœ€å¤§å…è®¸åŒæ—¶æŒæœ‰çš„ä»“ä½æ•°
            "max_drawdown": -0.05,    # æœ€å¤§å›æ’¤(ä¾‹å¦‚-0.05ä»£è¡¨-5%)
            "trend_ma_period": 50,    # è¶‹åŠ¿è¿‡æ»¤MAå‘¨æœŸ
            "risk_per_trade": 0.01    # å•ç¬”äº¤æ˜“é£é™©å æ¯”(1%)
        }

        # å¦‚æœä¼ å…¥äº† paramsï¼Œåˆ™ä¸é»˜è®¤å‚æ•°è¿›è¡Œåˆå¹¶
        if params:
            default_params.update(params)

        self.params = default_params
        self.df = data_df.copy()
        self.signals = None
        self.initial_capital = initial_capital

    def _safe_rolling(self, series, window, func):
        """å®‰å…¨çš„æ»šåŠ¨çª—å£è®¡ç®—"""
        return series.rolling(
            window=window,
            min_periods=1
        ).apply(lambda x: func(x), raw=False)

    def generate_signals(self):
        """
        ç”Ÿæˆäº¤æ˜“ä¿¡å·:
          1) ä»·æ ¼å˜åŒ–æ˜¯å¦è¶…è¿‡ ATRé˜ˆå€¼
          2) RSI æ˜¯å¦è¶…ä¹°/è¶…å–
          3) è¶‹åŠ¿è¿‡æ»¤ï¼šé€šè¿‡MAåˆ¤æ–­å¤§æ–¹å‘
          4) å»é™¤è¿ç»­åŒå‘ä¿¡å·
        """
        df = self.df
        p = self.params

        # ========== 1) åŸºç¡€æ•°æ®è®¡ç®— ==========
        # (a) æ»šåŠ¨çª—å£ä»·æ ¼å˜åŒ–
        df["roll_open"] = self._safe_rolling(df["open"], p["window"], lambda x: x.iloc[0])
        df["roll_close"] = self._safe_rolling(df["close"], p["window"], lambda x: x.iloc[-1])
        df["price_change"] = df["roll_close"] - df["roll_open"]

        # (b) ATR
        atr = ta.volatility.AverageTrueRange(
            high=df["high"], low=df["low"], close=df["close"], window=p["atr_period"]
        )
        df["ATR"] = atr.average_true_range()
        df["vol_threshold"] = df["ATR"] * p["atr_multiplier"]

        # (c) RSI
        rsi = ta.momentum.RSIIndicator(df["close"], window=p["rsi_window"])
        df["rsi"] = rsi.rsi()

        # (d) è¶‹åŠ¿è¿‡æ»¤: ç”¨MAåˆ¤æ–­æ˜¯å¦åœ¨å¤šå¤´(ä»·æ ¼>MA)æˆ–ç©ºå¤´(ä»·æ ¼<MA)
        df["MA"] = df["close"].rolling(window=p["trend_ma_period"], min_periods=1).mean()
        df["up_trend"] = df["close"] > df["MA"]
        df["down_trend"] = df["close"] < df["MA"]

        # ========== 2) åŸå§‹ä¿¡å· (åŒ…å«è¶‹åŠ¿è¿‡æ»¤) ==========
        df["raw_sell"] = (
            (df["price_change"] < -df["vol_threshold"]) &
            (df["rsi"] > p["rsi_upper"]) &
            (df["down_trend"] == True)  # ä»…åœ¨ç©ºå¤´è¶‹åŠ¿ä¸‹åšç©º
        )
        df["raw_buy"] = (
            (df["price_change"] > df["vol_threshold"]) &
            (df["rsi"] < p["rsi_lower"]) &
            (df["up_trend"] == True)    # ä»…åœ¨å¤šå¤´è¶‹åŠ¿ä¸‹åšå¤š
        )

        # ========== 3) ä¿¡å·å»é‡ï¼šé¿å…è¿ç»­åŒæ–¹å‘ä¿¡å· ==========
        df["sell"] = df["raw_sell"] & ~df["raw_sell"].shift(1).fillna(False)
        df["buy"]  = df["raw_buy"] & ~df["raw_buy"].shift(1).fillna(False)

        self.signals = df[[
            "timestamp", "open", "high", "low", "close",
            "price_change", "ATR", "rsi",
            "raw_sell", "raw_buy", "sell", "buy"
        ]].copy()

        print("\nğŸ”” ä¿¡å·ç»Ÿè®¡:")
        print(f"åšç©ºä¿¡å·: {self.signals['sell'].sum()}")
        print(f"åšå¤šä¿¡å·: {self.signals['buy'].sum()}")

    def run_backtest(self):
        """
        å›æµ‹é€»è¾‘:
          1) ä½¿ç”¨èµ„é‡‘æ›²çº¿, ç»´æŠ¤ equity
          2) è®¡ç®—æŒä»“æ•°é‡(position_size) = (é£é™©èµ„é‡‘) / (æ­¢æŸç©ºé—´)
          3) åŠ¨æ€æ›´æ–°å›æ’¤, è‹¥å›æ’¤è¶…è¿‡é˜ˆå€¼, åœæ­¢äº¤æ˜“
          4) å¹³ä»“æ—¶æ›´æ–°å®é™…ç›ˆäº -> equity
        """
        if self.signals is None:
            print("âŒ è¯·å…ˆè°ƒç”¨ generate_signals()")
            return None

        # --- åˆå§‹åŒ–èµ„é‡‘ç›¸å…³å˜é‡ ---
        equity = self.initial_capital
        peak_equity = equity
        max_drawdown_allowed = self.params["max_drawdown"]
        risk_per_trade = self.params["risk_per_trade"]  # å•ç¬”é£é™©å æ¯”(å¦‚0.01)

        trades = []

        # è¿™é‡Œ signals å·²åŒ…å«å¿…è¦å­—æ®µ(high, low, closeç­‰)
        merged_df = self.signals

        for idx, row in merged_df.iterrows():

            # 1) æ£€æŸ¥å›æ’¤
            current_drawdown = (equity - peak_equity) / peak_equity
            if current_drawdown < max_drawdown_allowed:
                print(f"âš ï¸ è§¦å‘æœ€å¤§å›æ’¤ {current_drawdown:.2%}, åœæ­¢äº¤æ˜“")
                break

            # 2) åˆ·æ–°å³°å€¼
            if equity > peak_equity:
                peak_equity = equity

            # 3) å¼€ä»“é€»è¾‘
            if len([t for t in trades if t["exit_time"] is None]) < self.params["max_trades"]:

                if row["sell"]:
                    entry_price = row["close"]
                    stop_loss_price = entry_price + (row["ATR"] * self.params["stop_loss"])
                    take_profit_price = entry_price - (row["ATR"] * self.params["take_profit"])

                    risk_amount = equity * risk_per_trade
                    stop_range = abs(entry_price - stop_loss_price)
                    position_size = risk_amount / stop_range if stop_range else 0

                    new_trade = {
                        "type": "short",
                        "entry_time": row["timestamp"],
                        "entry_price": entry_price,
                        "stop_loss": stop_loss_price,
                        "take_profit": take_profit_price,
                        "size": position_size,
                        "exit_time": None,
                        "exit_price": None,
                        "profit": None
                    }
                    trades.append(new_trade)

                elif row["buy"]:
                    entry_price = row["close"]
                    stop_loss_price = entry_price - (row["ATR"] * self.params["stop_loss"])
                    take_profit_price = entry_price + (row["ATR"] * self.params["take_profit"])

                    risk_amount = equity * risk_per_trade
                    stop_range = abs(entry_price - stop_loss_price)
                    position_size = risk_amount / stop_range if stop_range else 0

                    new_trade = {
                        "type": "long",
                        "entry_time": row["timestamp"],
                        "entry_price": entry_price,
                        "stop_loss": stop_loss_price,
                        "take_profit": take_profit_price,
                        "size": position_size,
                        "exit_time": None,
                        "exit_price": None,
                        "profit": None
                    }
                    trades.append(new_trade)
